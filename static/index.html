<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Mula price managment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .nav-tabs { cursor: pointer; margin-bottom: 20px; }
        .card-img-top { height: 180px; object-fit: cover; }
        .stat-card { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-light">

<div class="container py-4">
    <h2 class="mb-4 text-center"> portal for intelligent price managment</h2>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#gallery">store product</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#dashboard" onclick="loadStats()">analytical dashboard  </button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="gallery">
            <div id="product-list" class="row row-cols-1 row-cols-md-4 g-4 text-center"></div>
        </div>

        <div class="tab-pane fade" id="dashboard">
            <div class="row mb-4">
                <div class="col-md-4">
                    <button class="btn btn-danger w-100 py-3 mb-3" onclick="startScrape()">ðŸš€ new scrap and find products</button>
                    <div id="scrape-msg"></div>
                </div>
                <div class="col-md-8">
                    <div class="stat-card">
                        <h5>the average of price due to the categories</h5>
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="stat-card mt-4">
                <h5>database table</h5>
                <table class="table table-hover mt-3">
                    <thead class="table-dark">
                        <tr><th>product name </th><th>category</th><th>price</th></tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = 'http://127.0.0.1:8000';

    // Û±. Ù„ÙˆØ¯ Ù…Ø­ØµÙˆÙ„Ø§Øª ÙˆÛŒØªØ±ÛŒÙ†
    async function loadGallery() {
        const res = await fetch(`${API_URL}/products`);
        const data = await res.json();
        const list = document.getElementById('product-list');
        const tableBody = document.getElementById('table-body');
        list.innerHTML = ''; tableBody.innerHTML = '';
        
        data.forEach(p => {
            list.innerHTML += `
                <div class="col"><div class="card h-100 shadow-sm">
                    <img src="${p.image_url}" class="card-img-top">
                    <div class="card-body"><h6>${p.name}</h6><b class="text-success">${p.price} ${p.currency}</b></div>
                </div></div>`;
            tableBody.innerHTML += `<tr><td>${p.name}</td><td>${p.category}</td><td>${p.price} ${p.currency}</td></tr>`;
        });
    }

    // Û². Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±Ù¾Ø±
    async function startScrape() {
        document.getElementById('scrape-msg').innerHTML = "â³in scrapping..";
        const res = await fetch(`${API_URL}/run-scraper`, {method: 'POST'});
        const data = await res.json();
        alert(data.message || data.error);
    }

    // Û³. Ù„ÙˆØ¯ Ø¢Ù…Ø§Ø± Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø±
    async function loadStats() {
        const res = await fetch(`${API_URL}/stats`);
        const stats = await res.json();
        
        const labels = stats.map(s => s.category);
        const prices = stats.map(s => s.avg_price);

        if(window.myChart) window.myChart.destroy();
        const ctx = document.getElementById('categoryChart').getContext('2d');
        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'average price (EUR)', data: prices, backgroundColor: '#3498db' }]
            }
        });
    }

    loadGallery();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>